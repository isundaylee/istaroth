x-backend-common: &backend-common
  image: python:3.12-slim
  working_dir: /app
  volumes:
    - checkpoints:/data/checkpoints
    - ./data:/data/state
    - ../../istaroth:/app/istaroth:ro
    - ../../scripts:/app/scripts:ro
    - ../../migrations:/app/migrations:ro
    - ../../alembic.ini:/app/alembic.ini:ro
    - backend-venv:/app/.venv
    - uv-cache:/root/.cache/uv:ro
    - hf-cache:/root/.cache/huggingface
  env_file:
    - ../../.env.common
    - ../../.env.web
  environment:
    - PATH=/app/.venv/bin:/usr/local/bin:/usr/bin:/bin
    - ISTAROTH_DOCUMENT_STORE_SET=CHS:/data/checkpoints/chs
    - ISTAROTH_DATABASE_URI=sqlite+aiosqlite:////data/state/web.sqlite
    - ISTAROTH_TRAINING_DEVICE=cpu

services:
  seed-checkpoints:
    image: python:3.12-slim
    volumes:
      - ../../tmp/checkpoints:/src/checkpoints:ro
      - checkpoints:/data/checkpoints
    command: >-
      sh -c '
        if [ -z "$$(ls -A /data/checkpoints 2>/dev/null)" ]; then
          echo "Seeding checkpoints volume from host...";
          cp -a /src/checkpoints/. /data/checkpoints/;
          echo "Done.";
        else
          echo "Checkpoints volume already populated, skipping seed.";
        fi
      '

  backend-deps:
    <<: *backend-common
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    command: ["uv", "sync", "--frozen", "--no-group", "dev", "--group", "ml"]
    environment:
      - UV_LINK_MODE=symlink
    volumes:
      - ../../pyproject.toml:/app/pyproject.toml:ro
      - ../../uv.lock:/app/uv.lock:ro
      - backend-venv:/app/.venv
      - uv-cache:/root/.cache/uv

  db-migrate:
    <<: *backend-common
    command: ["alembic", "upgrade", "head"]
    depends_on:
      backend-deps:
        condition: service_completed_successfully

  retrieval:
    <<: *backend-common
    command: ["python", "-m", "istaroth.services.retrieval"]
    depends_on:
      backend-deps:
        condition: service_completed_successfully
      seed-checkpoints:
        condition: service_completed_successfully
    ports:
      - "9102:9102"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/docs')"]
      interval: 10s
      timeout: 5s
      start_period: 3600s
      retries: 3

  istaroth:
    <<: *backend-common
    command: ["python", "-m", "istaroth.services.backend", "--reload"]
    depends_on:
      backend-deps:
        condition: service_completed_successfully
      db-migrate:
        condition: service_completed_successfully
      retrieval:
        condition: service_healthy
    volumes:
      - checkpoints:/data/checkpoints
      - ./data:/data/state
      - ../../istaroth:/app/istaroth
      - ../../scripts:/app/scripts
      - ../../migrations:/app/migrations
      - ../../alembic.ini:/app/alembic.ini
      - backend-venv:/app/.venv
      - uv-cache:/root/.cache/uv:ro
    ports:
      - "9100:9100"
    environment:
      - PATH=/app/.venv/bin:/usr/local/bin:/usr/bin:/bin
      - ISTAROTH_DOCUMENT_STORE_SET=CHS:/data/checkpoints/chs
      - ISTAROTH_DATABASE_URI=sqlite+aiosqlite:////data/state/web.sqlite
      - ISTAROTH_RETRIEVAL_SERVICE_URL=http://retrieval:8002

  frontend:
    # Keep in sync with frontend/.nvmrc
    image: node:18-alpine
    working_dir: /app
    command: ["sh", "-c", "npm run dev -- --host 0.0.0.0 --port ${CONDUCTOR_PORT:-5173}"]
    depends_on:
      frontend-deps:
        condition: service_completed_successfully
      istaroth:
        condition: service_started
    ports:
      - "${CONDUCTOR_PORT:-5173}:${CONDUCTOR_PORT:-5173}"
    volumes:
      - ../../frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_PROXY_TARGET=http://istaroth:8000

  frontend-deps:
    # Keep in sync with frontend/.nvmrc
    image: node:18-alpine
    working_dir: /app
    command: ["npm", "ci"]
    volumes:
      - ../../frontend:/app
      - frontend-node-modules:/app/node_modules

volumes:
  checkpoints:
  backend-venv:
  frontend-node-modules:
  uv-cache:
    external: true
    name: uv-cache
  hf-cache:
    external: true
    name: hf-cache
