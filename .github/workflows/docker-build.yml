name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-tag:
    runs-on: ubuntu-latest
    outputs:
      timestamp_tag: ${{ steps.tag.outputs.timestamp_tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate timestamp tag
      id: tag
      run: |
        TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
        SHORT_SHA=$(git rev-parse --short HEAD)
        TIMESTAMP_TAG="${TIMESTAMP}-${SHORT_SHA}"
        echo "timestamp_tag=${TIMESTAMP_TAG}" >> $GITHUB_OUTPUT
        echo "Generated tag: ${TIMESTAMP_TAG}"

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Detect changes
      id: filter
      uses: dorny/paths-filter@v2
      with:
        filters: |
          backend:
            - 'istaroth/**'
            - 'scripts/**'
            - 'migrations/**'
            - 'alembic.ini'
            - 'uv.lock'
            - 'requirements-ml.txt'
            - 'requirements-app.txt'
            - 'pyproject.toml'
            - 'Dockerfile'
            - '.github/workflows/docker-build.yml'
          frontend:
            - 'frontend/**'
            - '.github/workflows/docker-build.yml'

  build-backend:
    needs: [generate-tag, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    environment: build-push-docker-image

    steps:
    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up uv
      uses: astral-sh/setup-uv@v5

    - name: Verify Docker export freshness
      run: |
        uv export --frozen --only-group ml --no-hashes --no-emit-project | diff - requirements-ml.txt
        uv export --frozen --no-group dev --no-group ml --no-hashes --no-emit-project | diff - requirements-app.txt

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: isundaylee/istaroth
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ needs.generate-tag.outputs.timestamp_tag }}

    - name: Build and push backend Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=registry,ref=isundaylee/istaroth:cache
        cache-to: type=registry,ref=isundaylee/istaroth:cache,mode=max
        platforms: linux/amd64,linux/arm64

  build-frontend:
    needs: [generate-tag, detect-changes]
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    environment: build-push-docker-image

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: isundaylee/istaroth-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ needs.generate-tag.outputs.timestamp_tag }}

    - name: Read Node.js version from .nvmrc
      id: node-version
      run: echo "version=$(cat frontend/.nvmrc)" >> $GITHUB_OUTPUT

    - name: Build and push frontend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=registry,ref=isundaylee/istaroth-frontend:cache
        cache-to: type=registry,ref=isundaylee/istaroth-frontend:cache,mode=max
        platforms: linux/amd64,linux/arm64
        build-args: |
          NODE_VERSION=${{ steps.node-version.outputs.version }}
